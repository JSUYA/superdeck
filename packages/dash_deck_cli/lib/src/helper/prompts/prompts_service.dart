import 'package:dash_deck_cli/src/helper/palm_service.dart';
import 'package:dash_deck_cli/src/helper/prompts/dto/prompt_data.dto.dart';
import 'package:dash_deck_cli/src/helper/prompts/dto/prompt_responses.dto.dart';
import 'package:dash_deck_core/dash_deck_core.dart';

final _defaultSafetySettings = [
  {"category": "HARM_CATEGORY_DEROGATORY", "threshold": "4"},
  {"category": "HARM_CATEGORY_TOXICITY", "threshold": "4"},
  {"category": "HARM_CATEGORY_VIOLENCE", "threshold": "4"},
  {"category": "HARM_CATEGORY_SEXUAL", "threshold": "4"},
  {"category": "HARM_CATEGORY_MEDICAL", "threshold": "4"},
  {"category": "HARM_CATEGORY_DANGEROUS", "threshold": "4"}
];

class PromptsService {
  PromptsService._();
  static PalmService _palmService = PalmService();
  static Future<SlideData> createSlide(
    PromptPresentationOutlineResponse outline,
    String topic,
  ) async {
    final data = {
      "prompt":
          "You are a skilled slide presentation designer with an expertise in formatting and structuring content. For any given TOPIC_NAM, generate a well-structured slide, ensuring that:\n\nThe content is relevant to the topic.\nThe information is concise, suitable for a single slide.\nFormatting follows these guidelines based on slide type:\nIntroduction: Use only # for the title. The title should be captivating and set the stage for the presentation. No sub-points or details.\nDiscussion: Start with ## for the main theme, followed by bullet points (-) to detail or expand upon the theme. Avoid excessive details; keep points succinct.\nTutorial: Begin with ## for the instructional topic. Use numbered steps (1., 2., ...) for procedures or processes.\nComparison: Use ## for the overarching theme. Differentiate items being compared using ### and use bullet points (-) for their characteristics.\nConclusion: Similar to Introduction, use only # for the concluding statement or summary. Should encapsulate the core message or takeaway from the presentation.\ninput: LLM Development vs. Traditional Development\noutput: # LLM Development vs. Traditional Development\n## Key Distinctions\n- LLM: Bypasses training, focuses on prompt design.\n- Traditional: Requires ML expertise, intensive training, hardware considerations.\ninput: What problems LLM Solves?\noutput: # LLM's Solutions\n## Addressing Language Complexities\n- Mastery in entity extraction, classification, and summarization.\n- Proficient in sentiment analysis and translation.\ninput: Prompt Design\noutput: # Prompt Design\n## Understanding Its Art\n- Creating prompts for desired LLM responses.\n- Balancing instructions and context.\ninput: Benefits of LLMs\noutput: # LLM Advantages\n## Why Opt for Large Language Models?\n- Multitaskers: One model, varied tasks.\n- Efficient and scalable: Needs minimal fine-tuning data.\ninput: Prompt design vs Prompt engineering\noutput: # Prompt Creation & Optimization\n## Distinguishing the Two\n- Design: Crafting for desired outputs.\n- Engineering: Fine-tuning for diverse applications.\ninput: What is prompt design in LLMs?\noutput: # Prompt Design in LLMs\n## Influencing Model Output\n- Quality of input shapes output caliber.\ninput: Examples of Prompt Design\noutput: # Practical Prompt Design\n## Diverse LLM Tasks\n- Social Media: Crafting thankful tweets.\n- Literature: Poems on melancholic subjects.\n- Professional: Emailing for a pay hike.\ninput: Cats vs. Dogs\noutput: # Cats vs. Dogs\n## Distinct Companions\n- Cats: Independent, serene, self-grooming.\n- Dogs: Social, trainable, enthusiastic about games.\ninput: What's inside a Cell?\noutput: # Cellular Components\n## Life's Building Blocks\n- Key parts: Nucleus, mitochondria, cell membrane.\n- Functions: Energy production, protein creation.\ninput: Digital vs. Traditional Marketing\noutput: # Digital vs. Traditional Marketing\n## The Advertising Landscape\n- Digital: Online presence, SEO, analytics.\n- Traditional: Print, TV & radio, limited tracking.\ninput: Plant-Based Diet Benefits\noutput: # Plant-Based Diet\n## Benefits for Body & Planet\n- Promotes heart health, natural weight loss.\n- Eco-friendly, reduced cancer risk.\ninput: Explain the difference between text summarization and question answering\noutput: # Summarization vs. Q&A\n## AI's Language Tasks\n| Task                 | Objective           | Output |\n|----------------------|----------------------|-------|\n| Text Summarization   | Condense text       | Shortened version |\n| Question Answering   | Answer based on text| Direct answer    |\ninput: $topic\noutput:",
      "model_name": "models/text-bison-001",
      "temperature": 0.7,
      "candidate_count": 1,
      "top_k": 40,
      "top_p": 0.95,
      "max_output_tokens": 1024,
      "stop_sequences": [],
      "safety_settings": _defaultSafetySettings,
    };
    final prompt = PromptData.fromJson(data);
    final response = await _palmService.generateTextWithPrompt(prompt);

    final firstCandidate = response?.candidates?.first;

    if (firstCandidate == null) {
      throw Exception('Unable to generate slide');
    }

    // Create a guid
    final id = '${DateTime.now().millisecondsSinceEpoch}';

    return SlideData(
      id: id,
      content: firstCandidate.output,
    );
  }

  static Future<String> createOutline(
    String topic,
  ) async {
    final data = {
      "prompt":
          "Prompt Context:\n\nYou are a leading curriculum designer, celebrated for creating logical and comprehensive slide presentation outlines. Your aim is to craft slide titles that flow seamlessly, ensuring each:\n\n- Relevance: Directly pertains to the topic in question.\n- Progression: Forms a cohesive structure throughout the presentation.\n- Tagging: Includes an appropriate slide type (title, comparison, quote, transition, bullet_points).\n- Detailing: Provides potential sub-topics or bullet points in Markdown format for added context.\n- Furthermore, enhance the aesthetics and layout of the slide by embedding meta-information:\n\nBackground Imagery: \nIntegrate a contextual background image by leveraging broader, thematic keywords that can yield relevant and appealing results from platforms like Unsplash. Use the format:\n{background: https://source.unsplash.com/random/900×700/?KEYWORD}\nReplace KEYWORD with a broad yet relevant term that captures the essence of the slide's content. Keywords such as \"motivation\", \"code\", \"fitness\", \"challenge\", etc., are more likely to provide generic but thematic visuals than very specific terms.\n\nLayout Configurations:\nWhile it's important to set a slide's layout to complement its content, choose a layout configuration only when it enhances the message. Available options include:\n\ncontentLeft: Positions markdown text to the left, with the background image to the right.\ncontentRight: Displays markdown text to the right, and the background image to the left.\ncover: Superimposes markdown content directly over the background image.\nYour goal is to ensure that each slide is optimized for teaching and audience engagement. Proper use of Markdown syntax and heading hierarchy is essential.\ninput: 5k for beginners\noutput: [\n  {\n    \"id\": \"1692833309562\",\n    \"content\": \"# Embarking on the Couch to 5k Journey\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700?runner\"\n    }\n  },\n  {\n    \"id\": \"1692833309563\",\n    \"content\": \"## The Vision\\n- Understanding the 5k goal\\n- The benefits of running\\n- Transforming from sedentary to active\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?jogging\"\n    }\n  },\n  {\n    \"id\": \"1692833309564\",\n    \"content\": \"## Debunking Myths\\n- 'I'm not a runner'\\n- '5k is too much for beginners'\\n- 'I don't have the time'\",\n    \"options\": {\n      \"layout\": \"contentRight\", \n      \"background\": \"https://source.unsplash.com/random/900×700/?procrastinate\"\n    }\n  },\n  {\n    \"id\": \"1692833309565\",\n    \"content\": \"## 'Every journey begins with a single step.' \\nLao Tzu\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?journey\"\n    }\n  },\n  {\n    \"id\": \"1692833309566\",\n    \"content\": \"## First Steps\\n- Starting with walking\\n- Introduce short run intervals\\n- Gradual progression\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?runner,beginner\"\n    }\n  },\n  {\n    \"id\": \"1692833309567\",\n    \"content\": \"## Tracking Progress\\n- Importance of recording milestones\\n- Using apps and wearable tech\\n- Celebrating small victories\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?exercise,journal\"\n    }\n  },\n  {\n    \"id\": \"1692833309568\",\n    \"content\": \"## Overcoming Challenges\\n- Mental barriers\\n- Physical obstacles\\n- Consistency is key\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?obstacle,runner\"\n    }\n  },\n  {\n    \"id\": \"1692833309569\",\n    \"content\": \"## 'The finish line is just the beginning of a whole new race.'\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?finish,runner\"\n    }\n  },\n  {\n    \"id\": \"1692833309570\",\n    \"content\": \"## Preparing for Race Day\\n- Picking the right event\\n- What to expect\\n- Strategies to complete your first 5k\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?runner,race\"\n    }\n  },\n  {\n    \"id\": \"1692833309571\",\n    \"content\": \"# Celebrating Your Couch to 5k Achievement\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?celebration\"\n    }\n  }\n]\ninput: Improve your sleep\noutput: [\n  {\n    \"id\": \"1692833309572\",\n    \"content\": \"# Mastering the Art of Sleep\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?sleeping\"\n    }\n  },\n  {\n    \"id\": \"1692833309573\",\n    \"content\": \"## The Importance of Sleep\\n- Rejuvenation of body and mind\\n- Boosting cognitive functions\\n- Maintaining emotional balance\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?brain\"\n    }\n  },\n  {\n    \"id\": \"1692833309574\",\n    \"content\": \"## Sleep Cycles & Stages\\n- REM vs. Non-REM sleep\\n- The significance of deep sleep\\n- Average sleep requirements\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?night-sky\"\n    }\n  },\n  {\n    \"id\": \"1692833309575\",\n    \"content\": \"## 'Sleep is the golden chain that ties health and our bodies together.' \\nThomas Dekker\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?lifestyle,health\"\n    }\n  },\n  {\n    \"id\": \"1692833309576\",\n    \"content\": \"## Creating a Sleep Schedule\\n- Setting a regular bedtime\\n- Importance of consistency\\n- Adjusting for weekends\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?schedule, sleep\"\n    }\n  },\n  {\n    \"id\": \"1692833309577\",\n    \"content\": \"## The Sleep Environment\\n- The ideal bedroom temperature\\n- Reducing noise and light\\n- Importance of a comfortable mattress\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?bedroom,bed,sleep\"\n    }\n  },\n  {\n    \"id\": \"1692833309578\",\n    \"content\": \"## Food, Drink, and Sleep\\n- Foods that promote sleep\\n- The effect of caffeine and alcohol\\n- When to eat before bed\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?coffee,cup\"\n    }\n  },\n  {\n    \"id\": \"1692833309579\",\n    \"content\": \"## 'Sleep is the best meditation.' -\\nDalai Lama\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?meditation\"\n    }\n  },\n  {\n    \"id\": \"1692833309580\",\n    \"content\": \"## Dealing with Sleep Disorders\\n- Recognizing signs of disorders\\n- When to see a specialist\\n- Benefits of sleep therapy\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?doctor,sleep\"\n    }\n  },\n  {\n    \"id\": \"1692833309581\",\n    \"content\": \"# Embrace a Future of Restful Nights\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?moon,night,sky\"\n    }\n  }\n]\ninput: Introduction to Flutter\noutput: [\n  {\n    \"id\": \"1692833420582\",\n    \"content\": \"# Flutter Framework: Unveiling Mobile App Development\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?mobile-app\"\n    }\n  },\n  {\n    \"id\": \"1692833420583\",\n    \"content\": \"## What is Flutter?\\n- Open-source UI software development toolkit\\n- Developed by Google\\n- Create applications for mobile, web, and desktop\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?programmer\"\n    }\n  },\n  {\n    \"id\": \"1692833420584\",\n    \"content\": \"## Dart: The Language Behind Flutter\\n- Object-oriented programming language\\n- Developed by Google\\n- Core of Flutter's operation\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?programming\"\n    }\n  },\n  {\n    \"id\": \"1692833420585\",\n    \"content\": \"## 'The future of mobile is the future of online. It is how people access online content now.' \\nDavid Murphy\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?future-tech\"\n    }\n  },\n  {\n    \"id\": \"1692833420586\",\n    \"content\": \"## Flutter's Advantages\\n- Single codebase for multiple platforms\\n- Hot Reload: Instant previews\\n- Rich set of fully customizable widgets\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?fast\"\n    }\n  },\n  {\n    \"id\": \"1692833420587\",\n    \"content\": \"## Setting Up Flutter\\n- Installation steps\\n- Required software and tools\\n- Creating your first Flutter app\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?coding\"\n    }\n  },\n  {\n    \"id\": \"1692833420588\",\n    \"content\": \"## Flutter's Widget-Based Architecture\\n- Everything is a widget\\n- Composing complex UIs from smaller pieces\\n- Stateful vs. Stateless widgets\",\n    \"options\": {\n      \"layout\": \"contentLeft\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?blueprint,mobile\"\n    }\n  },\n  {\n    \"id\": \"1692833420589\",\n    \"content\": \"## 'Any application that can be written in JavaScript, will eventually be written in JavaScript.' \\nJeff Atwood\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?javascript\"\n    }\n  },\n  {\n    \"id\": \"1692833420590\",\n    \"content\": \"## Exploring Flutter's Packages\\n- Accessing pre-made plugins and tools\\n- Importance of `pubspec.yaml`\\n- Popular Flutter packages to kickstart development\",\n    \"options\": {\n      \"layout\": \"contentRight\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?packages,plugin\"\n    }\n  },\n  {\n    \"id\": \"1692833420591\",\n    \"content\": \"# Dive into Flutter: Your Journey Begins\",\n    \"options\": {\n      \"layout\": \"cover\",\n      \"background\": \"https://source.unsplash.com/random/900×700/?road\"\n    }\n  }\n]\ninput:",
      "model_name": "models/text-bison-001",
      "temperature": 0.7,
      "candidate_count": 1,
      "top_k": 40,
      "top_p": 0.95,
      "max_output_tokens": 1024,
      "stop_sequences": [],
      "safety_settings": _defaultSafetySettings,
    };
    final prompt = PromptData.fromJson(data);

    final response = await _palmService.generateTextWithPrompt(prompt);

    final firstCandidate = response?.candidates?.first;

    if (firstCandidate == null) {
      throw Exception('Unable to generate presentation outline');
    }

    return firstCandidate.output;
  }
}
